<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Watchdog</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:        #0f1117;
    --surface:   #1a1d27;
    --surface2:  #222636;
    --border:    #2a2f42;
    --border2:   #363c54;
    --accent:    #f59e0b;
    --accent-dim:#78450a;
    --danger:    #f87171;
    --ok:        #6ee7b7;
    --text:      #cbd5e1;
    --subtext:   #64748b;
    --muted:     #3d4663;
    --mono:      'JetBrains Mono', monospace;
    --sans:      'Inter', sans-serif;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--sans);
    font-weight: 300;
    min-height: 100vh;
    padding: 40px 20px 80px;
  }

  .wrap { max-width: 820px; margin: 0 auto; }

  header {
    display: flex;
    align-items: center;
    gap: 14px;
    margin-bottom: 40px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border);
  }

  .logo {
    width: 32px; height: 32px;
    background: var(--accent);
    display: flex; align-items: center; justify-content: center;
    font-family: var(--mono);
    font-size: 0.9rem;
    font-weight: 700;
    color: #000;
    flex-shrink: 0;
  }

  header h1 { font-family: var(--mono); font-size: 0.95rem; font-weight: 700; color: var(--text); letter-spacing: 0.05em; }
  header p  { font-size: 0.72rem; color: var(--subtext); margin-top: 2px; }
  .divider  { flex: 1; }

  .pulse {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--ok);
    box-shadow: 0 0 0 0 rgba(110,231,183,0.4);
    animation: pulse 2s infinite;
  }
  @keyframes pulse {
    0%   { box-shadow: 0 0 0 0 rgba(110,231,183,0.4); }
    70%  { box-shadow: 0 0 0 6px rgba(110,231,183,0); }
    100% { box-shadow: 0 0 0 0 rgba(110,231,183,0); }
  }

  .section { margin-bottom: 24px; }
  .section-title {
    font-family: var(--mono);
    font-size: 0.62rem;
    letter-spacing: 0.18em;
    text-transform: uppercase;
    color: var(--subtext);
    margin-bottom: 10px;
  }

  .panel { background: var(--surface); border: 1px solid var(--border); padding: 20px; }

  .field-row { display: flex; gap: 8px; }
  .field-row input { flex: 1; }

  .field-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-bottom: 12px;
  }
  .field-grid .span2 { grid-column: 1 / -1; }

  label {
    display: block;
    font-family: var(--mono);
    font-size: 0.6rem;
    color: var(--subtext);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin-bottom: 4px;
  }

  input {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: var(--mono);
    font-size: 0.78rem;
    padding: 9px 12px;
    outline: none;
    transition: border-color 0.15s;
    appearance: none;
  }
  input:focus { border-color: var(--accent); }
  input::placeholder { color: var(--muted); }

  .btn-row { display: flex; gap: 8px; align-items: center; margin-top: 4px; }

  button {
    font-family: var(--mono);
    font-size: 0.7rem;
    font-weight: 500;
    letter-spacing: 0.06em;
    padding: 9px 16px;
    border: 1px solid;
    cursor: pointer;
    transition: all 0.12s;
    white-space: nowrap;
    line-height: 1;
  }

  .btn-primary { background: var(--accent); border-color: var(--accent); color: #000; }
  .btn-primary:hover { background: #ea6a0a; border-color: #ea6a0a; }

  .btn-ghost { background: transparent; border-color: var(--border2); color: var(--subtext); }
  .btn-ghost:hover { border-color: var(--text); color: var(--text); }

  .btn-ping { background: transparent; border-color: var(--accent-dim); color: var(--accent); }
  .btn-ping:hover { background: var(--accent); border-color: var(--accent); color: #000; }

  .btn-del { background: transparent; border-color: transparent; color: var(--muted); padding: 9px 10px; }
  .btn-del:hover { border-color: var(--danger); color: var(--danger); }

  button:disabled { opacity: 0.35; cursor: not-allowed; }

  .err-msg {
    font-family: var(--mono);
    font-size: 0.68rem;
    color: var(--danger);
    margin-top: 8px;
    min-height: 1em;
  }

  /* Cards */
  .cards { display: flex; flex-direction: column; gap: 10px; }

  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-left: 3px solid var(--muted);
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 16px;
    align-items: center;
    padding: 16px 16px 16px 18px;
    animation: slideIn 0.18s ease;
  }
  .card.watching { border-left-color: var(--ok); }
  .card.alert    { border-left-color: var(--danger); }

  @keyframes slideIn {
    from { opacity: 0; transform: translateY(-4px); }
    to   { opacity: 1; transform: none; }
  }

  .card-top { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }

  .card-id {
    font-family: var(--mono);
    font-size: 0.82rem;
    font-weight: 700;
    color: var(--text);
  }

  .badge {
    font-family: var(--mono);
    font-size: 0.58rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    padding: 2px 7px;
    border: 1px solid;
  }
  .badge-watching { color: var(--ok);     border-color: var(--ok); }
  .badge-alert    { color: var(--danger); border-color: var(--danger); animation: blink 1s step-end infinite; }
  .badge-unknown  { color: var(--muted);  border-color: var(--muted); }
  @keyframes blink { 50% { border-color: transparent; color: var(--muted); } }

  .card-stats {
    display: flex;
    flex-wrap: wrap;
    gap: 4px 20px;
    font-size: 0.72rem;
  }
  .k { font-family: var(--mono); font-size: 0.6rem; letter-spacing: 0.08em; color: var(--muted); margin-right: 4px; }
  .v     { font-family: var(--mono); color: var(--text); }
  .v-ok  { font-family: var(--mono); color: var(--ok); }
  .v-bad { font-family: var(--mono); color: var(--danger); }

  .card-flash {
    font-family: var(--mono);
    font-size: 0.65rem;
    margin-top: 6px;
    color: var(--accent);
    animation: fadeIn 0.2s ease;
  }
  .card-flash.err { color: var(--danger); }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

  .card-actions { display: flex; gap: 4px; align-items: center; }

  .empty {
    font-family: var(--mono);
    font-size: 0.7rem;
    color: var(--muted);
    text-align: center;
    padding: 36px;
    border: 1px dashed var(--border);
    letter-spacing: 0.08em;
  }
</style>
</head>
<body>
<div class="wrap">

  <header>
    <div class="logo">W</div>
    <div>
      <h1>watchdog</h1>
      <p>redis-backed dead man's switch</p>
    </div>
    <div class="divider"></div>
    <div class="pulse" title="polling every 5s"></div>
  </header>

  <div class="section">
    <div class="section-title">Lookup by ID</div>
    <div class="panel">
      <div class="field-row">
        <input id="search-input" type="text" placeholder="paste a watchdog id…" />
        <button class="btn-ghost" onclick="lookupById()">Fetch</button>
      </div>
      <div class="err-msg" id="search-err"></div>
    </div>
  </div>

  <div class="section">
    <div class="section-title">Create / Update</div>
    <div class="panel">
      <div class="field-grid">
        <div>
          <label>ID</label>
          <input id="f-id" type="text" placeholder="leave blank for UUID4" />
        </div>
        <div>
          <label>Timeout (s)</label>
          <input id="f-timeout" type="number" placeholder="600" />
        </div>
        <div>
          <label>Expire (s)</label>
          <input id="f-expire" type="number" placeholder="2592000" />
        </div>
        <div></div>
        <div class="span2">
          <label>Alert URL</label>
          <input id="f-alert" type="text" placeholder="https://…" />
        </div>
        <div class="span2">
          <label>Recover URL</label>
          <input id="f-recover" type="text" placeholder="https://…" />
        </div>
      </div>
      <div class="btn-row">
        <button class="btn-primary" onclick="createWatchdog()">Deploy</button>
        <button class="btn-ghost"   onclick="clearForm()">Clear</button>
      </div>
      <div class="err-msg" id="create-err"></div>
    </div>
  </div>

  <div class="section">
    <div class="section-title">Tracked watchdogs</div>
    <div class="cards" id="cards"></div>
  </div>

</div>
<script>
const API     = '';
const flashes = {};

const getIds   = ()  => JSON.parse(localStorage.getItem('wd_ids') || '[]');
const saveId   = id  => { const ids = getIds(); if (!ids.includes(id)) { ids.unshift(id); localStorage.setItem('wd_ids', JSON.stringify(ids)); } };
const removeId = id  => localStorage.setItem('wd_ids', JSON.stringify(getIds().filter(i => i !== id)));

async function api(method, path, body) {
  const r = await fetch(API + path, {
    method,
    headers: { 'Content-Type': 'application/json' },
    ...(body ? { body: JSON.stringify(body) } : {})
  });
  const data = await r.json().catch(() => ({}));
  if (!r.ok) throw new Error(data.detail || `HTTP ${r.status}`);
  return data;
}

function fmtTTL(s) {
  if (!s || s <= 0) return '—';
  if (s < 60)   return `${s}s`;
  if (s < 3600) return `${Math.floor(s/60)}m ${s%60}s`;
  return `${Math.floor(s/3600)}h ${Math.floor((s%3600)/60)}m`;
}

function uuid4() {
  return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
    (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16));
}

function renderCard(cfg) {
  const st    = cfg.status || 'unknown';
  const hCls  = st === 'alert' ? 'v-bad' : st === 'watching' ? 'v-ok' : 'v';
  const flash = flashes[cfg.id];
  return `<div class="card ${st}" id="card-${cfg.id}">
    <div>
      <div class="card-top">
        <span class="card-id">${cfg.id}</span>
        <span class="badge badge-${st}">${st}</span>
      </div>
      <div class="card-stats">
        <span><span class="k">TIMEOUT</span><span class="v">${fmtTTL(cfg.timeout)}</span></span>
        <span><span class="k">HEARTBEAT</span><span class="${hCls}">${fmtTTL(cfg.heartbeat_ttl)}</span></span>
        <span><span class="k">EXPIRES IN</span><span class="v">${fmtTTL(cfg.expire_in)}</span></span>
        <span><span class="k">ALERT</span><span class="v">${cfg.alert_url}</span></span>
        <span><span class="k">RECOVER</span><span class="v">${cfg.recover_url}</span></span>
      </div>
      ${flash ? `<div class="card-flash ${flash.err?'err':''}">${flash.msg}</div>` : ''}
    </div>
    <div class="card-actions">
      <button class="btn-ping"  onclick="ping('${cfg.id}')">Ping</button>
      <button class="btn-ghost" onclick="loadForm('${cfg.id}',${JSON.stringify(cfg)})">Edit</button>
      <button class="btn-del"   onclick="del('${cfg.id}')">✕</button>
    </div>
  </div>`;
}

async function refresh() {
  const ids = getIds();
  const el  = document.getElementById('cards');
  if (!ids.length) { el.innerHTML = '<div class="empty">no watchdogs tracked in this browser yet</div>'; return; }
  const results = await Promise.all(ids.map(id => api('GET', `/watchdog/${id}`).catch(() => null)));
  results.forEach((r,i) => { if (!r) removeId(ids[i]); });
  const valid = results.filter(Boolean);
  if (!valid.length) { el.innerHTML = '<div class="empty">no watchdogs tracked in this browser yet</div>'; return; }
  el.innerHTML = valid.map(renderCard).join('');
  valid.forEach(cfg => { delete flashes[cfg.id]; });
}

async function lookupById() {
  const id  = document.getElementById('search-input').value.trim();
  const err = document.getElementById('search-err');
  err.textContent = '';
  if (!id) return;
  try {
    await api('GET', `/watchdog/${id}`);
    saveId(id);
    document.getElementById('search-input').value = '';
    await refresh();
  } catch(e) { err.textContent = e.message; }
}

async function createWatchdog() {
  const err = document.getElementById('create-err');
  err.textContent = '';
  const id       = document.getElementById('f-id').value.trim() || uuid4();
  const alertUrl = document.getElementById('f-alert').value.trim();
  const recUrl   = document.getElementById('f-recover').value.trim();
  if (!alertUrl || !recUrl) { err.textContent = 'alert_url and recover_url are required'; return; }
  const body = { alert_url: alertUrl, recover_url: recUrl };
  const t = document.getElementById('f-timeout').value; if (t) body.timeout = parseInt(t);
  const e = document.getElementById('f-expire').value;  if (e) body.expire  = parseInt(e);
  try {
    await api('POST', `/watchdog/${id}`, body);
    saveId(id);
    clearForm();
    await refresh();
  } catch(e) { err.textContent = e.message; }
}

async function ping(id) {
  try {
    const r = await api('GET', `/watchdog/${id}/ping`);
    flashes[id] = { msg: r.status === 'recovered' ? '⚡ recovered — recover_url called' : '✓ pinged' };
  } catch(e) { flashes[id] = { msg: e.message, err: true }; }
  await refresh();
}

async function del(id) {
  try { await api('DELETE', `/watchdog/${id}`); } catch(e) { flashes[id] = { msg: e.message, err: true }; }
  removeId(id);
  await refresh();
}

function loadForm(id, cfg) {
  document.getElementById('f-id').value      = id;
  document.getElementById('f-timeout').value = cfg.timeout || '';
  document.getElementById('f-alert').value   = cfg.alert_url || '';
  document.getElementById('f-recover').value = cfg.recover_url || '';
}

function clearForm() {
  ['f-id','f-timeout','f-expire','f-alert','f-recover'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('create-err').textContent = '';
}

document.getElementById('search-input').addEventListener('keydown', e => { if (e.key === 'Enter') lookupById(); });

refresh();
setInterval(refresh, 5000);
</script>
</body>
</html>